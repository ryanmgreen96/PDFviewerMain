<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#ffffff">
    <title>Text Categorizer</title>
    <link rel="manifest" href="manifest.json">
    <script src="jquery.min.js"></script>
    <style>
        body {
            font-family: 'Centaur', serif;
            margin: 0;
            padding: 20px;
            background-color: white;
            color: hsl(40, 93%, 88%);
            font-size: 1.6em;
            /* light yellowish gold */
        }

        @font-face {
            font-family: 'Centaur';
            src: url('Centaur.woff2') format('woff2');

            font-weight: normal;
            font-style: normal;
        }

        .color-picker,
        .category-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .color-picker button {
            width: 30px;
            height: 30px;
            margin: 5px;
            border: 1px solid #999;
            border-radius: 4px;
            cursor: pointer;
        }

        .category-bar button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .text-piece {
            position: relative;
            padding-right: 50px;
            margin: 10px auto;
            padding: 10px;
            max-width: 600px;
            background-color: transparent;
            /* changed from a solid color */
            border: none;
            /* removed border */
        }

        .title-display {
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            font-style: italic;
            font-size: .7em;
            padding: 5px;
            color: #fff;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 1em;
            /* or 1.5em for more space */
            margin-bottom: .5em
        }



        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #800000;
            /* dark red */
            color: white;
            padding: 20px;
            box-shadow: 0 0 10px black;
            z-index: 1001;
            max-width: 90%;
            max-height: 90vh;
            /* Limits modal height */
            overflow-y: auto;
            /* Adds scroll inside modal */
            box-sizing: border-box;
        }


        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .edit-btn {
            position: absolute;
            right: 0px;
            top: 50%;
            /* default, will be overridden by JS */
            transform: translateY(-50%);
            cursor: pointer;
            background: #a07f7f;
            color: white;
            border: none;
            border-radius: 2px;
            padding: 5px 5px;
            font-size: .1em;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .bookmark-box {
            position: absolute;
            bottom: px;
            left: 10px;
        }

        textarea#modal-title {
            width: 500px;
            min-width: 300px;
            max-width: 100%;
            min-height: 150px;
            max-height: 60vh;
            overflow: auto;
            resize: both;
            /* allows horizontal and vertical resizing */
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        select#modal-category {
            border: 2px solid #fff;
            background-color: #600000;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        .filter-btn.active {
            background-color: #800000;
            color: white;
        }

        .color-picker button {
            color: white;
            font-weight: bold;
            transition: color 0.3s;
        }

        .color-picker button#white-bg-btn {
            color: black;
        }

        #content-container {
            all: unset;
        }
    </style>
</head>

<body>

    <div class="color-picker">
        <button data-color="#8c4545" style="background:#8c4545;"></button>
        <button data-color="#336d27" style="background:#336d27;"></button>
        <button data-color="#3e7c91" style="background:#3e7c91;"></button>
        <button data-color="#79599c" style="background:#79599c;"></button>
        <button id="white-bg-btn" data-color="#ffffff" style="background: white; border: 1px solid #999;">W</button>
    </div>


    <div class="category-bar">
        <button class="filter-btn" data-filter="Philo">Philo</button>
        <!-- <button class="filter-btn" data-filter="World">Wrld</button>
        <button class="filter-btn" data-filter="Principle">Prncpl</button> -->
        <button class="filter-btn" data-filter="joy">Joy</button>
        <button class="filter-btn" data-filter="Reflection">Reflection</button>
        <button class="filter-btn" data-filter="Work">Work</button>
        <button class="filter-btn" data-filter="Grub">Grub</button>
        <!-- <button class="filter-btn" data-filter="Civ">Civ</button> -->
        <button id="filter-clear"></button>
    </div>
    <div id="section-toc" style="text-align:center; margin-bottom: 1em;">
        <button data-section="fall24.html">Fall 2024</button>
        <button data-section="winter24.html">Winter 2024</button>
        <button data-section="spring25.html">Spring 2025</button>
    </div>

    <div class="bookmark-bar" style="text-align: center; margin-bottom: 10px;">
        <button id="show-bookmarked" style="font-size: 0.4em;">ðŸ”– </button>
    </div>
    <div id="content-container">
    
        </div>

    <div class="overlay"></div>
    <div class="modal">
        <label>
            <textarea id="modal-title"></textarea>
            <button id="save-meta">Save</button>
        </label>
        <label>
            <div id="modal-category">
                <label><input type="checkbox" value="Philo"> Philo</label><br>
                <!-- <label><input type="checkbox" value="World"> World</label><br>
                <label><input type="checkbox" value="Principle"> Principle</label><br> -->
                <label><input type="checkbox" value="joy"> Joy</label> <br>
                <label><input type="checkbox" value="Reflection"> Reflction</label><br><br>
                <label><input type="checkbox" value="Grub"> Grub</label><br>
                <label><input type="checkbox" value="Work"> Work</label><br>

                <!-- <label><input type="checkbox" value="Civ"> Civ</label> -->
            </div>
        </label><br><br>

        <button id="cancel-meta">Cancel</button>
    </div>
  
<script>



    if ("scrollRestoration" in history) {
            history.scrollRestoration = "manual";
        }

function initializeLoadedContent() {
    const bookmarkedId = localStorage.getItem("bookmarkId");

    $("#content-container .text-piece").each(function () {
        const fullId = $(this).attr("data-id");


        // Set title
        const title = localStorage.getItem(fullId + "_title") || "";
        $(this).find(".title-display").text(title);

        // Set category
        const cat = localStorage.getItem(fullId + "_cat") || "";
        $(this).attr("data-category", cat);

        // Set bookmark
        $(this).find(".bookmark-box").prop("checked", fullId === bookmarkedId);
    });
}



    function bindHandlers(sectionId) {
        let currentPiece = null;

        $(document).off("click", ".edit-btn").on("click", ".edit-btn", function () {
            currentPiece = $(this).closest(".text-piece");
            const id = currentPiece.attr("data-id");
            const title = localStorage.getItem(id + "_title") || "";
            const cats = (localStorage.getItem(id + "_cat") || "").split(",");
            $("#modal-title").val(title);
            $("#modal-category input").prop("checked", false);
            cats.forEach(c => {
                $("#modal-category input[value='" + c + "']").prop("checked", true);
            });
            $(".overlay, .modal").show();
        });

        $("#cancel-meta").off("click").on("click", function () {
            $(".overlay, .modal").hide();
        });

          $("#save-meta").off("click").on("click", function () {
            const title = $("#modal-title").val();
            const cats = [];
            $("#modal-category input:checked").each(function () {
                cats.push($(this).val());
            });
            const catStr = cats.join(",");
           const id = currentPiece.attr("data-id");

              currentPiece.find(".title-display").text(title);
              currentPiece.attr("data-category", catStr);
              localStorage.setItem(id + "_title", title);
              localStorage.setItem(id + "_cat", catStr);
            $(".overlay, .modal").hide();

            // Reapply saved data to all pieces of this section after save
            initializeLoadedContent(sectionId);
          });

     $(".bookmark-box").off("change").on("change", function () {
            const id = $(this).closest(".text-piece").attr("data-id");
            const section = id.split("_")[0]; // e.g. fall24 or winter24
            const pieceId = id;

            $(".bookmark-box").not(this).prop("checked", false);

            if ($(this).is(":checked")) {
                localStorage.setItem(`bookmark_${section}`, pieceId);
            } else {
                localStorage.removeItem(`bookmark_${section}`);
            }
        });


      $("#show-bookmarked").off("click").on("click", function () {
            const currentSection = $("#content-container .text-piece").first().attr("data-id")?.split("_")[0];
            if (!currentSection) {
                alert("No section loaded.");
                return;
            }

            const bookmarkedId = localStorage.getItem(`bookmark_${currentSection}`);

            if (!bookmarkedId) {
                alert("No bookmark saved for this section.");
                return;
            }

            const $checkbox = $(`.text-piece[data-id='${bookmarkedId}'] .bookmark-box`);
            if ($checkbox.length) {
                $('html, body').animate({
                    scrollTop: $checkbox.offset().top - 100
                }, 500);
            } else {
                alert("Bookmarked checkbox not found in current section.");
            }
        });



        $(window).off("scroll resize").on("scroll resize", updateEditButtons);
        updateEditButtons();
    }

    function updateEditButtons() {
        const scrollTop = $(window).scrollTop();
        const windowHeight = $(window).height();

        $('#content-container #content').each(function () {
            const $content = $(this);
            const $piece = $content.find('.text-piece');
            const $btn = $piece.find('.edit-btn');

            if ($piece.length === 0 || $btn.length === 0) return;

            const pieceTop = $piece.offset().top;
            const pieceBottom = pieceTop + $piece.outerHeight();

            if (pieceBottom > scrollTop && pieceTop < scrollTop + windowHeight) {
                let centerY = scrollTop + windowHeight / 2;
                centerY = Math.max(centerY, pieceTop + 20);
                centerY = Math.min(centerY, pieceBottom - 20);
                const btnTop = centerY - pieceTop;

                $btn.css({
                    top: btnTop + 'px',
                    opacity: 1,
                    pointerEvents: 'auto'
                });
            } else {
                $btn.css({
                    opacity: 0,
                    pointerEvents: 'none'
                });
            }
        });
    }

  function loadSection(file) {
    const sectionId = file.replace(".html", "");

    $("#content-container").load(file, function () {
        $("#content-container .text-piece").each(function () {
           const baseId = $(this).data("id");
            const fullId = `${sectionId}_${baseId}`;
            $(this).attr("data-id", fullId);
            $(this).find(".bookmark-box").attr("data-id", fullId);

        });

        initializeLoadedContent();
        bindHandlers();

        // Attempt auto-scroll to bookmarked item after load
        // const bookmarkedId = localStorage.getItem("bookmarkId");
        //  if (bookmarkedId) {
        //     const $checkbox = $(`.text-piece[data-id='${bookmarkedId}'] .bookmark-box`);
        //     if ($checkbox.length) {
        //          setTimeout(() => {
        //              requestAnimationFrame(() => {
        //                  $('html, body').animate({
        //                      scrollTop: $checkbox.offset().top - 100
        //                  }, 500);
        //              });
        //          }, 0);
        //      }

        //  }
    });
}





    $(function () {
        const savedBg = localStorage.getItem("bgColor");
        if (savedBg) $("body").css("background-color", savedBg);

        // const scrollY = localStorage.getItem("scrollY");
        // if (scrollY) $(window).scrollTop(scrollY);

        $(".color-picker button").on("click", function () {
            const color = $(this).data("color");
            $("body").css("background-color", color);
            localStorage.setItem("bgColor", color);

            if (color.toLowerCase() === "#ffffff" || color.toLowerCase() === "white") {
                $("body").css("color", "black");
                $(".title-display").css("color", "black");
            } else {
                $("body").css("color", "hsl(38, 72%, 75%)");
                $(".title-display").css("color", "#fff");
            }
        });

        $(".filter-btn").on("click", function () {
            const category = $(this).data("filter");
            $(this).toggleClass("active");

            const activeFilters = $(".filter-btn.active").map(function () {
                return $(this).data("filter");
            }).get();

            $("#content-container .text-piece").each(function () {
                const cats = ($(this).attr("data-category") || "").split(",");
                const matchAll = activeFilters.every(f => cats.includes(f));
                $(this).toggle(matchAll);
            });
        });

        $("#filter-clear").on("click", function () {
            $(".filter-btn").removeClass("active");
            $("#content-container .text-piece").show();
        });

        $("#section-toc button").on("click", function () {
            const file = $(this).data("section");
            loadSection(file);
        });

        // Load first section by default
        loadSection("fall24.html");

        // $(window).on("beforeunload", function () {
        //     localStorage.setItem("scrollY", window.scrollY);
        // });

        $("#modal-title").on("input", function () {
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";
        });
    });
</script>


    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log("Service Worker Registered"))
                .catch((err) => console.error("Service Worker Failed", err));
        }
    </script>

</body>

</html>